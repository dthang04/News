<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Th√™m / S·ª≠a tin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 30px;
            max-width: 700px;
        }
        .navbar {
            background-color: #004085;
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
            font-size: 30px;
        }
        footer {
            margin-top: 50px;
            text-align: center;
            color: #888;
            padding: 20px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="/posts">üì∞ H·ªá th·ªëng qu·∫£n l√Ω tin t·ª©c</a>
    </div>
</nav>

<div class="container bg-white p-4 rounded shadow-sm">
    <h3 class="mb-4">Th√™m / S·ª≠a tin b√†i</h3>

    <form th:action="@{/posts/save}" th:object="${post}" method="post">
        <input type="hidden" th:field="*{id}" />

        <div class="mb-3">
            <label class="form-label">Ti√™u ƒë·ªÅ</label>
            <input type="text" th:field="*{title}" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Th·ªÉ lo·∫°i</label>
            <div class="d-flex gap-2">
                <select id="categorySelect" th:field="*{category.id}" class="form-select" required>
                    <option value="" disabled selected>-- Ch·ªçn th·ªÉ lo·∫°i --</option>
                    <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
                </select>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">+</button>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">N·ªôi dung</label>
            <textarea th:field="*{content}" rows="6" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <select th:field="*{status}" class="form-select">
                <option value="Draft">Draft</option>
                <option value="Published">Published</option>
            </select>
        </div>

        <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
        <a th:href="@{/posts}" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
    </form>
</div>

<!-- ‚úÖ Modal th√™m th·ªÉ lo·∫°i m·ªõi -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addCategoryForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Th√™m th·ªÉ lo·∫°i m·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="newCategoryName" class="form-control" placeholder="Nh·∫≠p t√™n th·ªÉ lo·∫°i" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</div>

<footer>¬© 2025 H·ªá th·ªëng qu·∫£n l√Ω tin t·ª©c</footer>

<script>
    document.getElementById('addCategoryForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const name = document.getElementById('newCategoryName').value.trim();
        if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n th·ªÉ lo·∫°i!");

        // ‚úÖ L·∫•y CSRF token t·ª´ meta tag
        const token = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

        try {
            const response = await fetch('/categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify({ name })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Server error:", errorText);
                alert("T√™n th·ªÉ lo·∫°i ƒë√£ t·ªìn t·∫°i ho·∫∑c c√≥ l·ªói x·∫£y ra!");
                return;
            }

            const newCategory = await response.json();

            const select = document.getElementById('categorySelect');
            const option = document.createElement('option');
            option.value = newCategory.id;
            option.textContent = newCategory.name;
            select.appendChild(option);
            select.value = newCategory.id;

            document.getElementById('newCategoryName').value = "";
            bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();

        } catch (err) {
            console.error("Fetch error:", err);
            alert("L·ªói k·∫øt n·ªëi server!");
        }
    });
</script>

</body>
</html>
